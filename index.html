<!DOCTYPE html>
<meta charset='utf-8'>
<title>Compiler/decompiler for th06/th07/th08/th09 .end files</title>
<!--
# Copyright (c) 2018 by Egor.
#
# This is free and unencumbered software released into the public domain.
#
# Anyone is free to copy, modify, publish, use, compile, sell, or
# distribute this software, either in source code form or as a compiled
# binary, for any purpose, commercial or non-commercial, and by any
# means.
#
# In jurisdictions that recognize copyright laws, the author or authors
# of this software dedicate any and all copyright interest in the
# software to the public domain. We make this dedication for the benefit
# of the public at large and to the detriment of our heirs and
# successors. We intend this dedication to be an overt act of
# relinquishment in perpetuity of all present and future rights to this
# software under copyright law.
#
# THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,
# EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF
# MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.
# IN NO EVENT SHALL THE AUTHORS BE LIABLE FOR ANY CLAIM, DAMAGES OR
# OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,
# ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR
# OTHER DEALINGS IN THE SOFTWARE.
#
# For more information, please refer to <http://unlicense.org/>
-->
<style>body{text-align:center}</style>
<h1>Compiler/decompiler for th06/th07/th08/th09 .end files</h1>
<sup>(bird brain edition)</sup>
<p>Made by Egor of Touhou Patch Center.<br>Format documentation can be found <a href='https://www.thpatch.net/wiki/Format_reference/end06'>here</a>.<br></p>
<noscript><div>JavaScript is required to view this page.</div></noscript>
Encoding: <select id='encoding' value='utf-8'>
	<option selected value='utf-8'>UTF-8</option>
	<option value='ms932'>Shift-JIS</option>
	<option value='windows-1251'>Windows-1251 (Cyrillic)</option>
	<option value='windows-1252'>Windows-1252 (Latin)</option>
</select><br>
<span style='color:gray;font-size:smaller'>(ZUN's files use Shift-JIS. thcrap uses UTF-8)</span>
<table style='margin:auto'>
	<tr>
		<td><h3>Decompile</h3></td>
		<td><h3>Recompile</h3></td>
	</tr>
	<tr>
		<td><input id='filein' type='file'></td>
		<td><button onclick='writefile(anchout,output,encoding)'>recompile</button></td>
	</tr>
	<tr>
		<td><button onclick='readfile(filein,output,encoding)'>decompile</button></td>
		<td><a id='anchout' download='filename.end'></a></td>
	</tr>
	<tr>
		<td>
			<hr>
			<select style='display:none' id='patchSelect' oninput='patchSelected(this.selectedOptions[0],output)' >
				<option selected value=''>Fetch from server...</option>
			</select><br>
			<a style='font-size:smaller' id='patchSource'></a>
		</td>
		<td></td>
	</tr>
</table>
<textarea cols='80' rows='100' id='output'></textarea><br>
<script>
	"use strict";
	var splitonws = function(s) {
		var idx = s.search(/\s/);
		if(idx == -1) {
			return [s,''];
		}
		else {
			return [s.substring(0,idx), s.substring(idx)];
		}
	}, ltrim = function(s) {
		return s.replace(/^\s+/,'');
	};
	var formatters = {
		s:{
			tozun :function(s) {
				s = ltrim(s);
				if(s[0] != '"')
					throw new Error('string argument expected, got: '+s);
				var buf = '';
				var i = 1;
				while(i < s.length) {
					if(s[i] == '"') {
						++i;
						break;
					}
					else if(s[i] == '\\') {
						++i;
						var c = {
							'\\':'\\',
							'a':'\x07',
							'b':'\b',
							't':'\t',
							'n':'\n',
							'v':'\v',
							'f':'\f',
							'r':'\r',
							'"':'\"',
						}[s[i]];
						buf += c === undefined ? '\\'+s[i] : c;
					}
					else {
						buf += s[i];
					}
					++i;
				}
				return [buf, s.substring(i)];
			},
			tosource :function(s) {
				[
					[new RegExp('\\\\/','g'),'\\\\'],
					[new RegExp('\x07','g'),'\\a'],
					[new RegExp('\b','g'),'\\b'],
					[new RegExp('\t','g'),'\\t'],
					[new RegExp('\n','g'),'\\n'],
					[new RegExp('\v','g'),'\\v'],
					[new RegExp('\f','g'),'\\f'],
					[new RegExp('\r','g'),'\\r'],
					[new RegExp('\"','g'),'\\"'],
				].forEach(function(v) {
					s=s.replace(v[0], v[1]);
				});
				return '"'+s+'"';
			},
		},
		i:{
			tozun :function(s) {
				var arr = splitonws(ltrim(s));
				return [String(parseInt(arr[0])),arr[1]];
			},
			tosource :function(s) {
				return String(parseInt(s));
			},
		},
		c:{
			tozun :function(s) {
				var arg = splitonws(ltrim(s))
				if(arg[0].length != 7 || arg[0][0] != '#')
					throw new Error("expected #RRGGBB style string, got: " +arg[0]);
				return [String((parseInt(arg[0].substring(1,3),16)) | (parseInt(arg[0].substring(3,5),16)<<8) | (parseInt(arg[0].substring(5,7),16)<<16)), arg[1]];
			},
			tosource :function(s) {
				var col = parseInt(s);
				return '#' + (col&0xFF).toString(16) + ((col>>8)&0xFF).toString(16) + ((col>>16)&0xFF).toString(16);
			},
		},
	};
	var ops = [
		['', 'display', 's'],
		['2', 'fadein', 'i'],
		['3', 'fadeout', 'i'],
		['a', 'anm', 'iii'],
		['b', 'background', 's'],
		['c', 'color', 'c'],
		['F', 'exec', 's'],
		['M', 'musicfade', 'i'],
		['m', 'musicplay', 's'],
		['R', 'staffroll', 's'],
		['r', 'waitreset', 'ii'],
		['s', 'setdelay', 'ii'],
		['V', 'scrollbg', 'ii'],
		['v', 'setscroll', 'i'],
		['w', 'wait', 'ii'],
		['z', 'end', ''],
	];
	
	var tozun = function(op, args) {
		var s = '';
		if(op[0] != '')
			s = '@'+op[0];
		for(var i=0;i<op[2].length;i++) {
			var a = formatters[op[2][i]].tozun(args);
			s += a[0] + '\0';
			args = a[1];
		}
		return s+'\n';
	};
	var tosource = function(op, args) {
		var s = op[1];
		for(var i=0;i<op[2].length;i++) {
			s += ' '+formatters[op[2][i]].tosource(args[i]);
		}
		return s+'\n';
	};
	var compile = function(src, enc) {
		if(enc != 'utf-8')
			throw new Error("sjis/1251 write not supported (yet)");
		var arr = src.split('\n');
		var s = '';
		for(var i=0;i<arr.length;i++) {
			var line = arr[i].trim();
			if(line === '') continue;
			var a = splitonws(line);
			var od = ops.find(function(f) {return f[1] == a[0];});
			s += tozun(od,a[1]);
		}
		var encoder = new TextEncoder();
		return encoder.encode(s);
	};
	var decompile = function(ab, enc) {
		var decoder = new TextDecoder(enc);
		var arr = decoder.decode(ab).split('\n');
		arr.pop();
		var s = '';
		
		var warned = false;
		for(var i=0;i<arr.length;i++) {
			var op = '';
			var line = arr[i];
			if(line[0] == '@') {
				op = line[1];
				line = line.substring(2);
			}
			var args = line.split('\0');
			args.pop();
			var od = ops.find(function(f) {return f[0] == op;});
			if(!warned && args.length > od[2].length) {
				alert('extra arguments detected.\n\nthis has no effect on the game, but you won\'t be able to recompile the file "bit-for-bit".\nMost likely you\'re decompiling th08 NDT english translation.');
				warned = true;
			}
			s += tosource(od,args);
		}
		return s;
	};
	var errwrap = function(f) {
		return (function() {
			try {
				f.apply(null,arguments);
			}
			catch(err) {
				console.log(err);
				alert(err.message);
			}
		});
	};
	var readxhrUnsafe = function(url, output, enc) {
		var xhr = new XMLHttpRequest();
		xhr.open("GET",url);
		xhr.responseType = "arraybuffer";
		xhr.onloadend = errwrap(function() {
			if(xhr.readyState == 4 && xhr.status == 200 && xhr.responseType == "arraybuffer") {
				output.value = decompile(xhr.response, enc);
			}
		});
		xhr.send();
	};
	window.readxhr = errwrap(function(url, output, enc) {
		if(!url.match(new RegExp('^[a-z0-9]+/[a-z0-9]+/[a-z0-9]+\\.end$','i'))) {
			throw new Error("Unsafe url");
		}
		readxhrUnsafe("endfiles/"+url, output, enc);
	});
	window.readfile = errwrap(function(f, output, enc) {
		var reader = new FileReader();
		reader.onload = function() {
			output.value = decompile(reader.result, enc.value);
		};
		reader.readAsArrayBuffer(f.files[0]);
	});
	var downloadFilename='filename.end';
	window.writefile = errwrap(function(a, input, enc) {
		a.download = downloadFilename;
		if(a.href && a.href != '') URL.revokeObjectURL(a.href);
		a.href= URL.createObjectURL(new Blob([compile(input.value, enc.value)], {type:'application/octet-stream',endings:'transparent'}));
		a.innerText = 'download';
		var files = filein.files;
		if(files.length > 0)
			a.download = files[0].name;
	});
	var games = {};
	var spEndfiles = [];
	window.patchSelected = errwrap(function(opt, output) {
		if(opt.dataset.loadMore) {
			patchSelect.selectedIndex = 0;
			for(var opt2 of spEndfiles) {
				patchSelect.add(opt2, opt);
			}
			patchSelect.removeChild(opt);
		}
		if(opt.dataset.game !== undefined) {
			var game = games[opt.dataset.game];
			if(game) {
				patchSource.href = game.source;
				patchSource.innerHTML = "(source)";
				readxhr(opt.value, output, game.encoding);
			}
			else {
				throw new Error("Invalid url (no such lang/game)");
			}
		}
		else {
			patchSource.innerHTML = "";
			patchSource.href = "";
		}
	});
	var query = new URLSearchParams(window.location.search);
	var loadMode = "";
	if(query.has("loadWiki")) {
		loadMode = "loadWiki";
	}
	else if(query.has("load")) {
		loadMode = "loadLocal";
	}
	window.endfilesCallback = errwrap(function(obj) {
		for(var game in obj) {
			games[game] = {
				source: obj[game].source,
				encoding: obj[game].encoding
			};
			for(var file of obj[game].files) {
				var opt = document.createElement("option");
				opt.value = opt.text = game+"/"+file;
				opt.dataset.game = game;
				if(game.startsWith("ja/")) {
					patchSelect.add(opt);
				}
				else {
					spEndfiles.push(opt);
				}
			}
		}
		var opt = document.createElement("option");
		opt.dataset.loadMore='yes';
		opt.text = 'Load static translations';
		patchSelect.add(opt);
		patchSelect.style.display = 'inline';
		if(loadMode == "loadLocal") {
			var loadstr = query.get("load");
			var split = loadstr.split("/");
			if(split.length == 3) {
				var game = split[0] + "/" + split[1];
				console.log({value:split,dataset:{game:game}});
				patchSelected({value:loadstr,dataset:{game:game}}, output);
			}
			else {
				throw new Error("Invalid url (should be lang/game/file.end)");
			}
		}
	});
	if (loadMode == "loadWiki") {
		errwrap(function(loadstr) {
			if(loadstr=="") {
				return;
			}
			var apibase = "https://www.thpatch.net/w/api.php";
			var apicall = "?action=query&prop=imageinfo&iiprop=url&titles=File:";
			var apicall2="&format=json"

			if(!loadstr.match(new RegExp('^lang_[a-z]+-th0[6-9]-[a-z0-9]+\\.end$','i'))) {
				throw new Error("Unsafe url");
			}
			downloadFilename = loadstr;
			var url = apibase+apicall+loadstr+apicall2;
			var xhr = new XMLHttpRequest();
			xhr.open("GET",url);
			xhr.responseType = "text";
			xhr.onloadend = errwrap(function() {
				if(xhr.readyState == 4 && xhr.status == 200 && xhr.responseType == "text") {
					window.onLoadWiki(JSON.parse(xhr.response));
				}
			});
			xhr.send();
		})(query.get("loadWiki"));
	};
	window.onLoadWiki = errwrap(function(obj) {
		console.log(obj);
		if (!obj || !obj.query || !obj.query.pages) {
			throw new Error("API error: malformed response");
		}
		var page;
		for (var id in obj.query.pages) {
			if(id < 0) throw new Error("API error: paqe not found")
			page = obj.query.pages[id];
			break
		}
		if (!page) {
			throw new Error("API error: no pages");
		}
		if (!page.imageinfo || !page.imageinfo[0] || !page.imageinfo[0].url) {
			throw new Error("API error: malformed response (page)");
		}
		
		readxhrUnsafe(page.imageinfo[0].url, output, "utf-8");
	});
</script>
<script src='endfiles.js'></script>
